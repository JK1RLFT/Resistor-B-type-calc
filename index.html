<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>B型抵抗子合成抵抗</title>
  <style>
    body { font-family: sans-serif; margin: 5px; }
    h2 { text-align: center; font-size: 1.1em; margin-bottom: 20px; }
    .container {
      display: flex;
      flex-wrap: nowrap;
      justify-content: center;
      gap: 6px;
      margin-top: 5px;
    }
    .terminal {
      width: 35px; height: 35px;
      border: 2px solid #333; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; position: relative;
      background: #fff; font-size: 0.8em;
      flex-shrink: 0;
    }
    .selected-in, .selected-out {
      background: #222; color: #fff;
    }
    .resistor { font-weight: bold; font-size: 0.7em; align-self: center; flex-shrink: 0; }
    #result { margin-top: 20px; font-size: 0.9em; text-align: center; }
    #reset {
      display: block; margin: 20px auto;
      padding: 6px 12px; font-size: 0.8em;
    }
    .ring {
      position: absolute; border-radius: 50%; pointer-events: none;
    }
    @media (max-width: 600px) {
      .terminal { width: 30px; height: 30px; font-size: 0.7em; }
      .resistor { font-size: 0.6em; }
      h2 { font-size: 1em; }
    }
  </style>
</head>
<body>
  <h2>B型抵抗子合成抵抗</h2>
  <div class="container" id="terminals">
    <div class="terminal" data-id="A">A</div>
    <span class="resistor">0.5Ω</span>
    <div class="terminal" data-id="B">B</div>
    <span class="resistor">1Ω</span>
    <div class="terminal" data-id="C">C</div>
    <span class="resistor">2Ω</span>
    <div class="terminal" data-id="D">D</div>
    <span class="resistor">0.5Ω</span>
    <div class="terminal" data-id="E">E</div>
  </div>
  <button id="reset">リセット</button>
  <div id="result">合成抵抗: -- Ω</div>

  <div id="images" style="display: flex; flex-direction: column; align-items: center; margin-top: 10px;">
  <img src="B type chart1.png" alt="B type chart1" style="width:80%; max-width:300px; margin:6px 0;">
  <img src="B type chart2.png" alt="B type chart2" style="width:80%; max-width:300px; margin:6px 0;">
  <img src="B type chart3.png" alt="B type chart3" style="width:80%; max-width:300px; margin:6px 0;">
</div>

  <script>
    const terminals = ['A', 'B', 'C', 'D', 'E'];
    const resistors = [
      { from: 'A', to: 'B', value: 0.5 },
      { from: 'B', to: 'C', value: 1 },
      { from: 'C', to: 'D', value: 2 },
      { from: 'D', to: 'E', value: 0.5 }
    ];
    const jumperColors = ['#2196f3', '#ffeb3b', '#4caf50'];
    const roles = ['in', 'out', 'jumper1a', 'jumper1b', 'jumper2a', 'jumper2b', 'jumper3a', 'jumper3b'];
    let selections = [];
    let jumpers = [[], [], []];
    let inTerm = null, outTerm = null;

    function updateRings() {
      document.querySelectorAll('.terminal').forEach(btn => {
        btn.querySelectorAll('.ring').forEach(ring => ring.remove());
        let rings = [];
        jumpers.forEach((pair, i) => {
          if (pair.includes(btn.dataset.id)) rings.push(jumperColors[i]);
        });
        rings.forEach((color, idx) => {
          const ring = document.createElement('div');
          ring.className = 'ring';
          const baseSize = parseInt(getComputedStyle(btn).width);
          const borderWidth = 2;
          const size = baseSize + 2 * borderWidth * (idx + 1);
          ring.style.width = `${size}px`;
          ring.style.height = `${size}px`;
          ring.style.left = `${-(size - baseSize) / 2}px`;
          ring.style.top = `${-(size - baseSize) / 2}px`;
          ring.style.border = `${borderWidth}px solid ${color}`;
          btn.appendChild(ring);
        });
      });
    }

    document.querySelectorAll('.terminal').forEach(btn => {
      btn.onclick = () => {
        if (selections.length >= roles.length) return;
        const id = btn.dataset.id;
        selections.push(id);
        if (selections.length === 1) { btn.classList.add('selected-in'); inTerm = id; }
        else if (selections.length === 2) { btn.classList.add('selected-out'); outTerm = id; }
        else if (selections.length <= 4) { jumpers[0].push(id); }
        else if (selections.length <= 6) { jumpers[1].push(id); }
        else if (selections.length <= 8) { jumpers[2].push(id); }
        updateRings();
        showResistance();
      };
    });

    function showResistance() {
      if (!inTerm || !outTerm) {
        document.getElementById('result').textContent = '合成抵抗: -- Ω';
        return;
      }
      const nodes = terminals;
      let edges = [...resistors];
      jumpers.forEach(pair => {
        if (pair.length === 2) edges.push({ from: pair[0], to: pair[1], value: 0 });
      });

      let nodeIndex = {};
      let idx = 0;
      nodes.forEach(n => { if (n !== inTerm && n !== outTerm) nodeIndex[n] = idx++; });
      const N = idx;
      let A = Array(N).fill(0).map(() => Array(N).fill(0));
      let b = Array(N).fill(0);

      nodes.forEach(n1 => {
        if (n1 === inTerm || n1 === outTerm) return;
        let row = nodeIndex[n1];
        edges.forEach(e => {
          let n2 = (e.from === n1) ? e.to : (e.to === n1 ? e.from : null);
          if (!n2) return;
          let conductance = e.value === 0 ? 1e12 : 1 / e.value;
          if (n2 === inTerm) { b[row] += conductance * 1; A[row][row] += conductance; }
          else if (n2 === outTerm) { A[row][row] += conductance; }
          else { A[row][row] += conductance; A[row][nodeIndex[n2]] -= conductance; }
        });
      });

      function solveLinear(A, b) {
        let n = b.length, x = Array(n).fill(0);
        for (let i = 0; i < n; i++) {
          let maxRow = i;
          for (let k = i+1; k < n; k++) if (Math.abs(A[k][i]) > Math.abs(A[maxRow][i])) maxRow = k;
          [A[i], A[maxRow]] = [A[maxRow], A[i]];
          [b[i], b[maxRow]] = [b[maxRow], b[i]];
          for (let k = i+1; k < n; k++) {
            let c = A[k][i] / A[i][i];
            for (let j = i; j < n; j++) A[k][j] -= c * A[i][j];
            b[k] -= c * b[i];
          }
        }
        for (let i = n-1; i >= 0; i--) {
          let sum = b[i];
          for (let j = i+1; j < n; j++) sum -= A[i][j] * x[j];
          x[i] = sum / A[i][i];
        }
        return x;
      }

      let V = solveLinear(A, b);
      let voltages = {};
      nodes.forEach(n => voltages[n] = (n === inTerm) ? 1 : (n === outTerm ? 0 : V[nodeIndex[n]]));

      let Iin = 0;
      edges.forEach(e => {
        if (e.from === inTerm || e.to === inTerm) {
          let v2 = voltages[e.from === inTerm ? e.to : e.from];
          let conductance = e.value === 0 ? 1e12 : 1 / e.value;
          Iin += (voltages[inTerm] - v2) * conductance;
        }
      });
      let resistance = 1 / Iin;
      let resistance = 1 / Iin; // 高精度で計算（小数第5位以上）
      let rounded = Math.round(resistance * 10000) / 10000; // 小数第4位で四捨五入
      document.getElementById('result').textContent = `合成抵抗: ${rounded.toFixed(4)} Ω`;
    }

    document.getElementById('reset').onclick = () => {
      selections = []; jumpers = [[], [], []]; inTerm = null; outTerm = null;
      document.querySelectorAll('.terminal').forEach(btn => {
        btn.classList.remove('selected-in', 'selected-out');
        btn.querySelectorAll('.ring').forEach(ring => ring.remove());
      });
      document.getElementById('result').textContent = '合成抵抗: -- Ω';
    };
  </script>
</body>
</html>
